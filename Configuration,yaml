# Laad standaard set van integraties. Niet verwijderen.
default_config:

# Laad frontend thema's uit de themes-map
frontend:
  themes: !include_dir_merge_named themes

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml

input_boolean:
  dynamisch_15_minuten:
    name: Dynamisch 15 Minuten
    icon: mdi:clock-time-three-outline

input_text:
  dynamisch_nordpool_sensor:
    name: Dynamisch Nordpool Sensor
    icon: mdi:cash
    max: 250
    mode: text

  dynamisch_handmatige_periode:
    name: Dynamisch Handmatige Periode
    icon: mdi:view-grid
    max: 250
    mode: text

  dynamisch_handmatige_periode_morgen:
    name: Dynamisch Handmatige Periode Morgen
    icon: mdi:view-grid
    max: 250
    mode: text

input_number:
  dynamisch_minimale_spread:
    name: Dynamisch Minimale Spread
    icon: mdi:percent-box
    min: 0
    max: 100
    step: 1
    unit_of_measurement: '%'
    mode: box

  dynamisch_goedkoopste_x_periode:
    name: Dynamisch Goedkoopste X Periode
    icon: mdi:view-grid-plus
    min: 0
    max: 96
    step: 1
    mode: box

  dynamisch_duurste_x_periode:
    name: Dynamisch Duurste X Periode
    icon: mdi:view-grid-plus
    min: 0
    max: 96
    step: 1
    mode: box

  dynamisch_goedkoopste_x_periode_morgen:
    name: Dynamisch Goedkoopste X Periode Morgen
    icon: mdi:view-grid-plus
    min: 0
    max: 96
    step: 1
    mode: box

  dynamisch_duurste_x_periode_morgen:
    name: Dynamisch Duurste X Periode Morgen
    icon: mdi:view-grid-plus
    min: 0
    max: 96
    step: 1
    mode: box

template:
  - sensor:
      - name: "Dynamisch Nordpool"
        unique_id: dynamisch_nordpool
        icon: mdi:cash
        unit_of_measurement: "€/kWh"
        state: >-
          {% set ingevuld = states('input_text.dynamisch_nordpool_sensor') %}
          {% if ingevuld | lower | regex_match('^sensor\\..+') and states(ingevuld) not in ['unknown', 'unavailable', 'none'] %}
            {% set nordpool = ingevuld %}
          {% else %}
            {% set nordpool = none %}
          {% endif %}

          {% if nordpool is not none %}
            {% set use_15_min = is_state('input_boolean.dynamisch_15_minuten', 'on') %}
            {% if use_15_min %}
              {% set data = state_attr(nordpool, 'raw_today') or [] %}
              {% set nowts = as_timestamp(now()) %}
              {% set current = namespace(val=None) %}
              {% for p in data %}
                {% set s = as_timestamp(as_datetime(p.start)) %}
                {% set e = as_timestamp(as_datetime(p.end)) %}
                {% if nowts >= s and nowts < e %}
                  {% set current.val = (p.value) | round(5) %}
                {% endif %}
              {% endfor %}
              {{ current.val if current.val is not none else 'unknown' }}
            {% else %}
              {% set raw = state_attr(nordpool, 'raw_today') %}
              {% set nu = now() %}
              {% if raw %}
                {% set current_hour_values = raw 
                  | selectattr('start', '>=', nu.replace(minute=0, second=0, microsecond=0)) 
                  | selectattr('start', '<', nu.replace(minute=0, second=0, microsecond=0) + timedelta(hours=1)) 
                  | map(attribute='value') 
                  | list %}
                {% if current_hour_values %}
                  {{ (current_hour_values | sum / current_hour_values | count) | round(5) }}
                {% else %}
                  {{ states(nordpool) }}
                {% endif %}
              {% else %}
                {{ states(nordpool) }}
              {% endif %}
            {% endif %}
          {% else %}
            unknown
          {% endif %}
        attributes:
          raw_today: >-
            {% set ingevuld = states('input_text.dynamisch_nordpool_sensor') %}
            {% if ingevuld | lower | regex_match('^sensor\\..+') and states(ingevuld) not in ['unknown', 'unavailable', 'none'] %}
              {% set nordpool = ingevuld %}
            {% else %}
              {% set nordpool = none %}
            {% endif %}

            {% if nordpool is not none %}
              {% set use_15_min = is_state('input_boolean.dynamisch_15_minuten', 'on') %}
              {% set raw = state_attr(nordpool, 'raw_today') %}
              {% if raw %}
                [
                {% if use_15_min %}
                  {% for item in raw %}
                    {
                      "start": "{{ item.start.isoformat() }}",
                      "end": "{{ item.end.isoformat() }}",
                      "value": {{ item.value }}
                    }{% if not loop.last %},{% endif %}
                  {% endfor %}
                {% else %}
                  {% set hourly = raw | groupby('start.hour') %}
                  {% for hour_group in hourly %}
                    {% set values = hour_group.list | map(attribute='value') | list %}
                    {% set hour_start = hour_group.list[0].start.replace(minute=0, second=0, microsecond=0) %}
                    {% set hour_end = hour_start + timedelta(hours=1) %}
                    {
                      "start": "{{ hour_start.isoformat() }}",
                      "end": "{{ hour_end.isoformat() }}",
                      "value": {{ (values | sum / values | count) | round(5) }}
                    }{% if not loop.last %},{% endif %}
                  {% endfor %}
                {% endif %}
                ]
              {% else %}
                []
              {% endif %}
            {% else %}
              []
            {% endif %}
          raw_tomorrow: >-
            {% set ingevuld = states('input_text.dynamisch_nordpool_sensor') %}
            {% if ingevuld | lower | regex_match('^sensor\\..+') and states(ingevuld) not in ['unknown', 'unavailable', 'none'] %}
              {% set nordpool = ingevuld %}
            {% else %}
              {% set nordpool = none %}
            {% endif %}

            {% if nordpool is not none %}
              {% set use_15_min = is_state('input_boolean.dynamisch_15_minuten', 'on') %}
              {% set raw = state_attr(nordpool, 'raw_tomorrow') %}
              {% if raw %}
                [
                {% if use_15_min %}
                  {% for item in raw %}
                    {
                      "start": "{{ item.start.isoformat() }}",
                      "end": "{{ item.end.isoformat() }}",
                      "value": {{ item.value }}
                    }{% if not loop.last %},{% endif %}
                  {% endfor %}
                {% else %}
                  {% set hourly = raw | groupby('start.hour') %}
                  {% for hour_group in hourly %}
                    {% set values = hour_group.list | map(attribute='value') | list %}
                    {% set hour_start = hour_group.list[0].start.replace(minute=0, second=0, microsecond=0) %}
                    {% set hour_end = hour_start + timedelta(hours=1) %}
                    {
                      "start": "{{ hour_start.isoformat() }}",
                      "end": "{{ hour_end.isoformat() }}",
                      "value": {{ (values | sum / values | count) | round(5) }}
                    }{% if not loop.last %},{% endif %}
                  {% endfor %}
                {% endif %}
                ]
              {% else %}
                []
              {% endif %}
            {% else %}
              []
            {% endif %}

      - name: "Dynamisch Spread Indicatie"
        unique_id: dynamisch_spread_indicatie
        icon: mdi:percent-box
        unit_of_measurement: "%"
        state: >
          {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_today') %}
          {% if uren %}
            {% set goedkoop = uren | selectattr('goedkoop','equalto','ja') | list %}
            {% set duur = uren | selectattr('duur','equalto','ja') | list %}
            {% if goedkoop | count > 0 and duur | count > 0 %}
              {% set avg_goedkoop = goedkoop | map(attribute='value') | sum / goedkoop | count %}
              {% set avg_duur = duur | map(attribute='value') | sum / duur | count %}
              {{ ((avg_duur - avg_goedkoop) / avg_goedkoop * 100) | round(1) }}
            {% else %}
              0
            {% endif %}
          {% else %}
            0
          {% endif %}
        attributes:
          handmatige_periode: >
            {% if states('input_text.dynamisch_handmatige_periode') | length > 0 %}
              n.v.t.
            {% else %}
              {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_today') %}
              {% if uren %}
                {% set ns = namespace(result=[]) %}
                {% for uur in uren %}
                  {% if uur.goedkoop == 'ja' %}
                    {% set ns.result = ns.result + ['G' ~ (uur.start | as_datetime).strftime('%H:%M')] %}
                  {% elif uur.duur == 'ja' %}
                    {% set ns.result = ns.result + ['D' ~ (uur.start | as_datetime).strftime('%H:%M')] %}
                  {% endif %}
                {% endfor %}
                {{ ns.result | join(';') }}
              {% else %}
                ""
              {% endif %}
            {% endif %}
          goedkoopste_periode: >
            {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_today') %}
            {% if uren %}
              {% set goedkoop = uren | selectattr('goedkoop','equalto','ja') | sort(attribute='start') | list %}
              [
              {% for uur in goedkoop %}
                "{{ (uur.start | as_datetime).strftime('%H:%M') }} - €{{ '%.4f' | format(uur.value) }}"
                {% if not loop.last %}, {% endif %}
              {% endfor %}
              ]
            {% else %}
              []
            {% endif %}
          duurste_periode: >
            {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_today') %}
            {% if uren %}
              {% set duur = uren | selectattr('duur','equalto','ja') | sort(attribute='start') | list %}
              [
              {% for uur in duur %}
                "{{ (uur.start | as_datetime).strftime('%H:%M') }} - €{{ '%.4f' | format(uur.value) }}"
                {% if not loop.last %}, {% endif %}
              {% endfor %}
              ]
            {% else %}
              []
            {% endif %}
          gemiddelde_goedkoop: >
            {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_today') %}
            {% set goedkoop = uren | selectattr('goedkoop','equalto','ja') | list %}
            {% if goedkoop | count > 0 %}
              €{{ ('%.4f' % (goedkoop | map(attribute='value') | sum / goedkoop | count)) }}
            {% else %}
              n.v.t.
            {% endif %}
          gemiddelde_duur: >
            {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_today') %}
            {% set duur = uren | selectattr('duur','equalto','ja') | list %}
            {% if duur | count > 0 %}
              €{{ ('%.4f' % (duur | map(attribute='value') | sum / duur | count)) }}
            {% else %}
              n.v.t.
            {% endif %}

      - name: "Dynamisch Spread Indicatie NOM"
        unique_id: dynamisch_spread_indicatie_NOM
        icon: mdi:percent-box
        unit_of_measurement: "%"
        state: >
          {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_today') %}
          {% set duurste = state_attr('sensor.dynamisch_goedkoopste_periode', 'duurste_na_eerste_goedkope') %}
          {% if uren and duurste %}
            {% set avg_goedkoop = (uren | selectattr('goedkoop','equalto','ja') | map(attribute='value') | sum) / (uren | selectattr('goedkoop','equalto','ja') | list | count) %}
            {% set avg_duur = (duurste | map(attribute='value') | sum) / (duurste | list | count) %}
            {{ ((avg_duur - avg_goedkoop) / avg_goedkoop * 100) | round(1) }}
          {% else %}
            0
          {% endif %}
        attributes:
          handmatige_periode: >
            {% if states('input_text.dynamisch_handmatige_periode') | length > 0 %}
              n.v.t.
            {% else %}
              {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_today') %}
              {% if uren %}
                {% set ns = namespace(result=[]) %}
                {% for uur in uren %}
                  {% if uur.goedkoop == 'ja' %}
                    {% set ns.result = ns.result + ['G' ~ (uur.start | as_datetime).strftime('%H:%M')] %}
                  {% elif uur.duur == 'ja' %}
                    {% set ns.result = ns.result + ['D' ~ (uur.start | as_datetime).strftime('%H:%M')] %}
                  {% endif %}
                {% endfor %}
                {{ ns.result | join(';') }}
              {% else %}
                ""
              {% endif %}
            {% endif %}
          goedkoopste_periode: >
            {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_today') %}
            {% set goedkoop = uren | selectattr('goedkoop','equalto','ja') | sort(attribute='start') | list %}
            [
            {% for uur in goedkoop %}
              "{{ (uur.start | as_datetime).strftime('%H:%M') }} - €{{ '%.4f' | format(uur.value) }}"
              {% if not loop.last %}, {% endif %}
            {% endfor %}
            ]
          duurste_periode: >
            {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'duurste_na_eerste_goedkope') %}
            {% set duur = uren | sort(attribute='value', reverse=true) | list %}
            [
            {% for uur in duur %}
              "{{ (uur.start | as_datetime).strftime('%H:%M') }} - €{{ '%.4f' | format(uur.value) }}"
              {% if not loop.last %}, {% endif %}
            {% endfor %}
            ]
          gemiddelde_goedkoop: >
            {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_today') %}
            {% set goedkoop = uren | selectattr('goedkoop','equalto','ja') | list %}
            {% if goedkoop | count > 0 %}
              €{{ ('%.4f' % (goedkoop | map(attribute='value') | sum / goedkoop | count)) }}
            {% else %}
              n.v.t.
            {% endif %}
          gemiddelde_duur: >
            {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'duurste_na_eerste_goedkope') %}
            {% set duur = uren | selectattr('duur','equalto','ja') | list %}
            {% if duur | count > 0 %}
              €{{ ('%.4f' % (duur | map(attribute='value') | sum / duur | count)) }}
            {% else %}
              n.v.t.
            {% endif %}

      - name: "Dynamisch Spread Indicatie Morgen"
        unique_id: dynamisch_spread_indicatie_morgen
        icon: mdi:percent-box
        unit_of_measurement: "%"
        state: >
          {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_tomorrow') %}
          {% if uren %}
            {% set goedkoop = uren | selectattr('goedkoop','equalto','ja') | list %}
            {% set duur = uren | selectattr('duur','equalto','ja') | list %}
            {% if goedkoop | count > 0 and duur | count > 0 %}
              {% set avg_goedkoop = goedkoop | map(attribute='value') | sum / goedkoop | count %}
              {% set avg_duur = duur | map(attribute='value') | sum / duur | count %}
              {{ ((avg_duur - avg_goedkoop) / avg_goedkoop * 100) | round(1) }}
            {% else %}
              0
            {% endif %}
          {% else %}
            0
          {% endif %}
        attributes:
          handmatige_periode: >
            {% if states('input_text.dynamisch_handmatige_periode_morgen') | length > 0 %}
              n.v.t.
            {% else %}
              {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_tomorrow') %}
              {% if uren %}
                {% set ns = namespace(result=[]) %}
                {% for uur in uren %}
                  {% if uur.goedkoop == 'ja' %}
                    {% set ns.result = ns.result + ['G' ~ (uur.start | as_datetime).strftime('%H:%M')] %}
                  {% elif uur.duur == 'ja' %}
                    {% set ns.result = ns.result + ['D' ~ (uur.start | as_datetime).strftime('%H:%M')] %}
                  {% endif %}
                {% endfor %}
                {{ ns.result | join(';') }}
              {% else %}
                ""
              {% endif %}
            {% endif %}
          goedkoopste_periode: >
            {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_tomorrow') %}
            {% if uren %}
              {% set goedkoop = uren | selectattr('goedkoop','equalto','ja') | sort(attribute='start') | list %}
              [
              {% for uur in goedkoop %}
                "{{ (uur.start | as_datetime).strftime('%H:%M') }} - €{{ '%.4f' | format(uur.value) }}"
                {% if not loop.last %}, {% endif %}
              {% endfor %}
              ]
            {% else %}
              []
            {% endif %}
          duurste_periode: >
            {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_tomorrow') %}
            {% if uren %}
              {% set duur = uren | selectattr('duur','equalto','ja') | sort(attribute='start') | list %}
              [
              {% for uur in duur %}
                "{{ (uur.start | as_datetime).strftime('%H:%M') }} - €{{ '%.4f' | format(uur.value) }}"
                {% if not loop.last %}, {% endif %}
              {% endfor %}
              ]
            {% else %}
              []
            {% endif %}
          gemiddelde_goedkoop: >
            {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_tomorrow') %}
            {% set goedkoop = uren | selectattr('goedkoop','equalto','ja') | list %}
            {% if goedkoop | count > 0 %}
              €{{ ('%.4f' % (goedkoop | map(attribute='value') | sum / goedkoop | count)) }}
            {% else %}
              n.v.t.
            {% endif %}
          gemiddelde_duur: >
            {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_tomorrow') %}
            {% set duur = uren | selectattr('duur','equalto','ja') | list %}
            {% if duur | count > 0 %}
              €{{ ('%.4f' % (duur | map(attribute='value') | sum / duur | count)) }}
            {% else %}
              n.v.t.
            {% endif %}

      - name: "Dynamisch Spread Indicatie NOM Morgen"
        unique_id: dynamisch_spread_indicatie_nom_morgen
        icon: mdi:percent-box
        unit_of_measurement: "%"
        state: >
          {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_tomorrow') %}
          {% set duurste = state_attr('sensor.dynamisch_goedkoopste_periode', 'duurste_na_eerste_goedkope_morgen') %}
          {% if uren and duurste %}
            {% set avg_goedkoop = (uren | selectattr('goedkoop','equalto','ja') | map(attribute='value') | sum) / (uren | selectattr('goedkoop','equalto','ja') | list | count) %}
            {% set avg_duur = (duurste | map(attribute='value') | sum) / (duurste | list | count) %}
            {{ ((avg_duur - avg_goedkoop) / avg_goedkoop * 100) | round(1) }}
          {% else %}
            0
          {% endif %}
        attributes:
          handmatige_periode: >
            {% if states('input_text.dynamisch_handmatige_periode_morgen') | length > 0 %}
              n.v.t.
            {% else %}
              {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_tomorrow') %}
              {% if uren %}
                {% set ns = namespace(result=[]) %}
                {% for uur in uren %}
                  {% if uur.goedkoop == 'ja' %}
                    {% set ns.result = ns.result + ['G' ~ (uur.start | as_datetime).strftime('%H:%M')] %}
                  {% elif uur.duur == 'ja' %}
                    {% set ns.result = ns.result + ['D' ~ (uur.start | as_datetime).strftime('%H:%M')] %}
                  {% endif %}
                {% endfor %}
                {{ ns.result | join(';') }}
              {% else %}
                ""
              {% endif %}
            {% endif %}
          goedkoopste_periode: >
            {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_tomorrow') %}
            {% set goedkoop = uren | selectattr('goedkoop','equalto','ja') | sort(attribute='start') | list %}
            [
            {% for uur in goedkoop %}
              "{{ (uur.start | as_datetime).strftime('%H:%M') }} - €{{ '%.4f' | format(uur.value) }}"
              {% if not loop.last %}, {% endif %}
            {% endfor %}
            ]
          duurste_periode: >
            {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'duurste_na_eerste_goedkope_morgen') %}
            {% set duur = uren | sort(attribute='value', reverse=true) | list %}
            [
            {% for uur in duur %}
              "{{ (uur.start | as_datetime).strftime('%H:%M') }} - €{{ '%.4f' | format(uur.value) }}"
              {% if not loop.last %}, {% endif %}
            {% endfor %}
            ]
          gemiddelde_goedkoop: >
            {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_tomorrow') %}
            {% set goedkoop = uren | selectattr('goedkoop','equalto','ja') | list %}
            {% if goedkoop | count > 0 %}
              €{{ ('%.4f' % (goedkoop | map(attribute='value') | sum / goedkoop | count)) }}
            {% else %}
              n.v.t.
            {% endif %}
          gemiddelde_duur: >
            {% set uren = state_attr('sensor.dynamisch_goedkoopste_periode', 'duurste_na_eerste_goedkope_morgen') %}
            {% set duur = uren | selectattr('duur','equalto','ja') | list %}
            {% if duur | count > 0 %}
              €{{ ('%.4f' % (duur | map(attribute='value') | sum / duur | count)) }}
            {% else %}
              n.v.t.
            {% endif %}

      - name: "Dynamisch Duurste Periode"
        unique_id: dynamisch_duurste_periode
        icon: mdi:progress-clock
        state: >
          {% set prijzen = state_attr('sensor.dynamisch_nordpool', 'raw_today') %}
          {% set handmatige = states('input_text.dynamisch_handmatige_periode') %}
          {% set aantal_duur = states('input_number.dynamisch_duurste_x_periode') | int %}
          {% set kwartier = is_state('input_boolean.dynamisch_15_minuten', 'on') %}
          {% set default_delta = timedelta(minutes=15) if kwartier else timedelta(hours=1) %}
          {% if prijzen is iterable %}
            {% set ns = namespace(dure_starttijden=[]) %}
            {% if handmatige | length > 0 %}
              {% for item in handmatige.split(';') %}
                {% if item[0] == 'D' %}
                  {% set tijden = item[1:] %}
                  {% if '-' in tijden %}
                    {% set start_str = tijden.split('-')[0] %}
                    {% set eind_str = tijden.split('-')[1] %}
                    {% set range_block = True %}
                  {% else %}
                    {% set start_str = tijden %}
                    {% set range_block = False %}
                  {% endif %}
                  {% for uur in prijzen %}
                    {% set dt_start = uur.start | as_datetime %}
                    {% set dt_end = uur.end | as_datetime %}
                    {% set dag = dt_start.strftime('%Y-%m-%d') %}
                    {% set tz = dt_start.tzinfo %}
                    {% set start_dt = strptime(dag ~ ' ' ~ start_str, '%Y-%m-%d %H:%M').replace(tzinfo=tz) %}
                    {% if range_block %}
                      {% set eind_dt = strptime(dag ~ ' ' ~ eind_str, '%Y-%m-%d %H:%M').replace(tzinfo=tz) %}
                      {% if eind_dt <= start_dt %}
                        {% set eind_dt = eind_dt + timedelta(days=1) %}
                      {% endif %}
                      {% set eind_dt = eind_dt + timedelta(seconds=1) %}
                    {% else %}
                      {% set eind_dt = start_dt + default_delta %}
                    {% endif %}
                    {% if dt_start < eind_dt and dt_end > start_dt %}
                      {% set ns.dure_starttijden = ns.dure_starttijden + [uur.start] %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% endfor %}
            {% else %}
              {% set prijzen_sorted = prijzen | sort(attribute='value') %}
              {% if aantal_duur > 0 %}
                {% set ns.dure_starttijden = prijzen_sorted[-aantal_duur:] | map(attribute='start') | list %}
              {% else %}
                {% set ns.dure_starttijden = [] %}
              {% endif %}
            {% endif %}
            {% set nu = now().astimezone() %}
            {% set actief = prijzen
              | selectattr('start', 'in', ns.dure_starttijden)
              | selectattr('start', 'le', nu.isoformat())
              | selectattr('end', 'gt', nu.isoformat())
              | list %}
            {{ 'Ja' if actief | length > 0 else 'Nee' }}
          {% else %}
            Onbekend
          {% endif %}
        attributes:
          raw_today: >
            {% set prijzen = state_attr('sensor.dynamisch_goedkoopste_periode', 'raw_today') %}
            {% set handmatige = states('input_text.dynamisch_handmatige_periode') %}
            {% set aantal_goedkoop = states('input_number.dynamisch_goedkoopste_x_periode') | int %}
            {% set aantal_duur = states('input_number.dynamisch_duurste_x_periode') | int %}
            {% if prijzen is iterable %}
              {% set ns = namespace(goede_starttijden=[], dure_starttijden=[]) %}
              {% if handmatige | length > 0 %}
                {% for item in handmatige.split(';') %}
                  {% set type = item[0] %}
                  {% set tijden = item[1:] %}
                  {% for uur in prijzen %}
                    {% if uur.start[11:16] == tijden %}
                      {% if type == 'G' %}
                        {% set ns.goede_starttijden = ns.goede_starttijden + [uur.start] %}
                      {% elif type == 'D' %}
                        {% set ns.dure_starttijden = ns.dure_starttijden + [uur.start] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                {% endfor %}
              {% else %}
                {% set prijzen_sorted = prijzen | sort(attribute='value') %}
                {% set ns.goede_starttijden = prijzen_sorted[:aantal_goedkoop] | map(attribute='start') | list %}
                {% if aantal_duur > 0 %}
                  {% set ns.dure_starttijden = prijzen_sorted[-aantal_duur:] | map(attribute='start') | list %}
                {% else %}
                  {% set ns.dure_starttijden = [] %}
                {% endif %}
              {% endif %}
              [
              {% for uur in prijzen %}
                {
                  "start": "{{ uur.start }}",
                  "end": "{{ uur.end }}",
                  "value": {{ uur.value }},
                  "goedkoop": "{{ 'ja' if uur.start in ns.goede_starttijden else 'nee' }}",
                  "duur": "{{ 'ja' if uur.start in ns.dure_starttijden else 'nee' }}"
                }{% if not loop.last %},{% endif %}
              {% endfor %}
              ]
            {% else %}
              []
            {% endif %}

      - name: "Dynamisch Goedkoopste Periode"
        unique_id: dynamisch_goedkoopste_periode
        icon: mdi:progress-clock
        state: >
          {% set prijzen = state_attr('sensor.dynamisch_nordpool', 'raw_today') %}
          {% set handmatige = states('input_text.dynamisch_handmatige_periode') %}
          {% set aantal_goedkoop = states('input_number.dynamisch_goedkoopste_x_periode') | int %}
          {% set kwartier = is_state('input_boolean.dynamisch_15_minuten', 'on') %}
          {% set default_delta = timedelta(minutes=15) if kwartier else timedelta(hours=1) %}
          {% if prijzen is iterable %}
            {% set ns = namespace(goedkope_starttijden=[]) %}
            {% if handmatige | length > 0 %}
              {% for item in handmatige.split(';') %}
                {% if item[0] == 'G' %}
                  {% set tijden = item[1:] %}
                  {% if '-' in tijden %}
                    {% set start_str = tijden.split('-')[0] %}
                    {% set eind_str = tijden.split('-')[1] %}
                    {% set range_block = True %}
                  {% else %}
                    {% set start_str = tijden %}
                    {% set range_block = False %}
                  {% endif %}
                  {% for uur in prijzen %}
                    {% set dt_start = uur.start | as_datetime %}
                    {% set dt_end = uur.end | as_datetime %}
                    {% set dag = dt_start.strftime('%Y-%m-%d') %}
                    {% set tz = dt_start.tzinfo %}
                    {% set start_dt = strptime(dag ~ ' ' ~ start_str, '%Y-%m-%d %H:%M').replace(tzinfo=tz) %}
                    {% if range_block %}
                      {% set eind_dt = strptime(dag ~ ' ' ~ eind_str, '%Y-%m-%d %H:%M').replace(tzinfo=tz) %}
                      {% if eind_dt <= start_dt %}
                        {% set eind_dt = eind_dt + timedelta(days=1) %}
                      {% endif %}
                      {% set eind_dt = eind_dt + timedelta(seconds=1) %}
                    {% else %}
                      {% set eind_dt = start_dt + default_delta %}
                    {% endif %}
                    {% if dt_start < eind_dt and dt_end > start_dt %}
                      {% set ns.goedkope_starttijden = ns.goedkope_starttijden + [uur.start] %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
              {% endfor %}
            {% else %}
              {% set prijzen_sorted = prijzen | sort(attribute='value') %}
              {% set ns.goedkope_starttijden = prijzen_sorted[:aantal_goedkoop] | map(attribute='start') | list %}
            {% endif %}
            {% set nu = now().astimezone() %}
            {% set in_goedkoop_blok = prijzen
              | selectattr('start', 'in', ns.goedkope_starttijden)
              | selectattr('start', 'le', nu.isoformat())
              | selectattr('end', 'gt', nu.isoformat())
              | list %}
            {{ 'Ja' if in_goedkoop_blok | length > 0 else 'Nee' }}
          {% else %}
            Onbekend
          {% endif %}
        attributes:
          raw_today: >
            {% set prijzen = state_attr('sensor.dynamisch_nordpool', 'raw_today') %}
            {% set handmatige = states('input_text.dynamisch_handmatige_periode') %}
            {% set aantal_goedkoop = states('input_number.dynamisch_goedkoopste_x_periode') | int %}
            {% set aantal_duur = states('input_number.dynamisch_duurste_x_periode') | int %}
            {% set kwartier = is_state('input_boolean.dynamisch_15_minuten', 'on') %}
            {% set default_delta = timedelta(minutes=15) if kwartier else timedelta(hours=1) %}
            {% if prijzen is iterable %}
              {% set ns = namespace(goedkope_starttijden=[], dure_starttijden=[]) %}
              {% if handmatige | length > 0 %}
                {% for item in handmatige.split(';') %}
                  {% set type = item[0] %}
                  {% set tijden = item[1:] %}
                  {% if '-' in tijden %}
                    {% set start_str = tijden.split('-')[0] %}
                    {% set eind_str = tijden.split('-')[1] %}
                    {% set range_block = True %}
                  {% else %}
                    {% set start_str = tijden %}
                    {% set range_block = False %}
                  {% endif %}
                  {% for uur in prijzen %}
                    {% set dt_start = uur.start | as_datetime %}
                    {% set dt_end = uur.end | as_datetime %}
                    {% set dag = dt_start.strftime('%Y-%m-%d') %}
                    {% set tz = dt_start.tzinfo %}
                    {% set start_dt = strptime(dag ~ ' ' ~ start_str, '%Y-%m-%d %H:%M').replace(tzinfo=tz) %}
                    {% if range_block %}
                      {% set eind_dt = strptime(dag ~ ' ' ~ eind_str, '%Y-%m-%d %H:%M').replace(tzinfo=tz) %}
                      {% if eind_dt <= start_dt %}
                        {% set eind_dt = eind_dt + timedelta(days=1) %}
                      {% endif %}
                      {% set eind_dt = eind_dt + timedelta(seconds=1) %}
                    {% else %}
                      {% set eind_dt = start_dt + default_delta %}
                    {% endif %}
                    {% if dt_start < eind_dt and dt_end > start_dt %}
                      {% if type == 'G' %}
                        {% set ns.goedkope_starttijden = ns.goedkope_starttijden + [uur.start] %}
                      {% elif type == 'D' %}
                        {% set ns.dure_starttijden = ns.dure_starttijden + [uur.start] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                {% endfor %}
              {% else %}
                {% set prijzen_sorted = prijzen | sort(attribute='value') %}
                {% set ns.goedkope_starttijden = prijzen_sorted[:aantal_goedkoop] | map(attribute='start') | list %}
                {% if aantal_duur > 0 %}
                  {% set ns.dure_starttijden = prijzen_sorted[-aantal_duur:] | map(attribute='start') | list %}
                {% else %}
                  {% set ns.dure_starttijden = [] %}
                {% endif %}
              {% endif %}
              [
              {% for uur in prijzen %}
                {
                  "start": "{{ uur.start }}",
                  "end": "{{ uur.end }}",
                  "value": {{ uur.value }},
                  "goedkoop": "{{ 'ja' if uur.start in ns.goedkope_starttijden else 'nee' }}",
                  "duur": "{{ 'ja' if uur.start in ns.dure_starttijden else 'nee' }}"
                }{% if not loop.last %},{% endif %}
              {% endfor %}
              ]
            {% else %}
              []
            {% endif %}
          raw_tomorrow: >
            {% set prijzen = state_attr('sensor.dynamisch_nordpool', 'raw_tomorrow') %}
            {% set handmatige = states('input_text.dynamisch_handmatige_periode_morgen') %}
            {% set aantal_goedkoop = states('input_number.dynamisch_goedkoopste_x_periode_morgen') | int %}
            {% set aantal_duur = states('input_number.dynamisch_duurste_x_periode_morgen') | int %}
            {% set kwartier = is_state('input_boolean.dynamisch_15_minuten', 'on') %}
            {% set default_delta = timedelta(minutes=15) if kwartier else timedelta(hours=1) %}
            {% if prijzen is iterable %}
              {% set ns = namespace(goedkope_starttijden=[], dure_starttijden=[]) %}
              {% if handmatige | length > 0 %}
                {% for item in handmatige.split(';') %}
                  {% set type = item[0] %}
                  {% set tijden = item[1:] %}
                  {% if '-' in tijden %}
                    {% set start_str = tijden.split('-')[0] %}
                    {% set eind_str = tijden.split('-')[1] %}
                    {% set range_block = True %}
                  {% else %}
                    {% set start_str = tijden %}
                    {% set range_block = False %}
                  {% endif %}
                  {% for uur in prijzen %}
                    {% set dt_start = uur.start | as_datetime %}
                    {% set dt_end = uur.end | as_datetime %}
                    {% set dag = dt_start.strftime('%Y-%m-%d') %}
                    {% set tz = dt_start.tzinfo %}
                    {% set start_dt = strptime(dag ~ ' ' ~ start_str, '%Y-%m-%d %H:%M').replace(tzinfo=tz) %}
                    {% if range_block %}
                      {% set eind_dt = strptime(dag ~ ' ' ~ eind_str, '%Y-%m-%d %H:%M').replace(tzinfo=tz) %}
                      {% if eind_dt <= start_dt %}
                        {% set eind_dt = eind_dt + timedelta(days=1) %}
                      {% endif %}
                      {% set eind_dt = eind_dt + timedelta(seconds=1) %}
                    {% else %}
                      {% set eind_dt = start_dt + default_delta %}
                    {% endif %}
                    {% if dt_start < eind_dt and dt_end > start_dt %}
                      {% if type == 'G' %}
                        {% set ns.goedkope_starttijden = ns.goedkope_starttijden + [uur.start] %}
                      {% elif type == 'D' %}
                        {% set ns.dure_starttijden = ns.dure_starttijden + [uur.start] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                {% endfor %}
              {% else %}
                {% set prijzen_sorted = prijzen | sort(attribute='value') %}
                {% set ns.goedkope_starttijden = prijzen_sorted[:aantal_goedkoop] | map(attribute='start') | list %}
                {% if aantal_duur > 0 %}
                  {% set ns.dure_starttijden = prijzen_sorted[-aantal_duur:] | map(attribute='start') | list %}
                {% else %}
                  {% set ns.dure_starttijden = [] %}
                {% endif %}
              {% endif %}
              [
              {% for uur in prijzen %}
                {
                  "start": "{{ uur.start }}",
                  "end": "{{ uur.end }}",
                  "value": {{ uur.value }},
                  "goedkoop": "{{ 'ja' if uur.start in ns.goedkope_starttijden else 'nee' }}",
                  "duur": "{{ 'ja' if uur.start in ns.dure_starttijden else 'nee' }}"
                }{% if not loop.last %},{% endif %}
              {% endfor %}
              ]
            {% else %}
              []
            {% endif %}
          duurste_na_eerste_goedkope: >
            {% set prijzen = state_attr('sensor.dynamisch_goedkoopste_periode','raw_today') %}
            {% if prijzen %}
              {% set eerste_goedkoop = prijzen
                | selectattr('goedkoop','eq','ja')
                | map(attribute='start')
                | map('as_datetime')
                | sort
                | first %}
              [
              {% for uur in prijzen
                if uur.duur == 'ja'
                and (uur.start | as_datetime > eerste_goedkoop)
              %}
                {
                  "start": "{{ uur.start }}",
                  "end": "{{ uur.end }}",
                  "value": {{ uur.value }},
                  "goedkoop": "{{ uur.goedkoop }}",
                  "duur": "ja"
                }{% if not loop.last %},{% endif %}
              {% endfor %}
              ]
            {% else %}
              []
            {% endif %}
          duurste_na_eerste_goedkope_morgen: >
            {% set prijzen = state_attr('sensor.dynamisch_goedkoopste_periode','raw_tomorrow') %}

            {% if prijzen %}
              {% set eerste_goedkoop = prijzen
                | selectattr('goedkoop','eq','ja')
                | map(attribute='start')
                | map('as_datetime')
                | sort
                | first %}
              [
              {% for uur in prijzen
                if uur.duur == 'ja'
                and (uur.start | as_datetime > eerste_goedkoop)
              %}
                {
                  "start": "{{ uur.start }}",
                  "end": "{{ uur.end }}",
                  "value": {{ uur.value }},
                  "goedkoop": "{{ uur.goedkoop }}",
                  "duur": "ja"
                }{% if not loop.last %},{% endif %}
              {% endfor %}
              ]
            {% else %}
              []
            {% endif %}
